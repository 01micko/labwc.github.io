#!/usr/bin/env bash
#
# This script depends on pandoc
#

die () {
	printf 'fatal: %b\n' "$@" >&2
	exit 1
}

build_src_pages () {
	template="$(<"src/template.html")"
	for md in src/*.md; do
		filename=${md##*/}
		html="${filename/%.md/.html}"
		printf '%s\n' "    GEN         ${html}"
		if [[ $html != index.html ]]; then
			header="<a href='index.html'>Home</a>"
		fi
		printf '%b' "${template/'{{content}}'/$header$(pandoc "$md")}" >"${html}"
		header=
	done
}

build_man_pages () {
	if ! [[ -d ../labwc/build/docs ]]; then
		printf 'warn: %b\n' "Need labwc next to labwc.github.io with man pages built" >&2
		return
	fi
	template="$(sed -e 's/sans-serif/monospace/' src/template.html)"
	for manual in ../labwc/build/docs/*; do
		filename=${manual##*/}
		out=$(basename ${manual}).html
		printf '%s\n' "    GEN         ${out}"
		header="<a href='index.html'>Home</a>"
		printf '%b' "${template/'{{content}}'/$header$(pandoc --from man "$manual")}" >"${out}"
		./fix-bullet-formatting.py "${out}"
	done
}

main () {
	build_src_pages
	build_man_pages
}

main "$@"

